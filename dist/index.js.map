{"version":3,"sources":["../index.js"],"names":["contexts","stateful","render","StatefulComponent","type","hookContext","index","hooks","hook","length","Error","factory","inputs","some","input","value","reducer","initialState","state","setState","dispatch","args","ref","useHook","setter","current","defaultValue","nextValue","forceUpdate","use","effect","memoize","onMount","dispose","memo","context","contextName","shift","Consumer","Provider","children","handler","mount","didMountHandlers","push","forEach","props","PureComponent","displayName","name"],"mappings":"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","sourcesContent":["import { PureComponent, createContext, createElement } from \"react\";\n\nconst contexts = {};\n\nexport function stateful(render) {\n  class StatefulComponent extends PureComponent {\n    didMountHandlers = [];\n\n    useHook = type => {\n      const { hookContext } = this;\n      const { index, hooks } = hookContext;\n      // create new hook if not any\n      const hook =\n        hooks[index] ||\n        (hooks[index] = {\n          type,\n          index: hooks.length\n        });\n      if (type !== hook.type) {\n        throw new Error(\"Invalid hook usage\");\n      }\n      hookContext.index++;\n      return hook;\n    };\n\n    memoize = (hook, factory, inputs = []) => {\n      if (\n        !hook.inputs ||\n        hook.inputs.some((input, index) => input !== inputs[index])\n      ) {\n        hook.value = factory(...inputs);\n        hook.inputs = inputs;\n      }\n      return hook.value;\n    };\n\n    hookContext = {\n      hooks: [],\n      index: 0,\n\n      reducer: (reducer, initialState) => {\n        const [state, setState] = this.hookContext.state(initialState);\n\n        function dispatch(...args) {\n          setState(reducer(state, ...args));\n        }\n\n        return [state, dispatch];\n      },\n\n      ref: () => {\n        const hook = this.useHook(\"ref\");\n        if (!hook.setter) {\n          hook.setter = value => (hook.setter.current = value);\n        }\n        return hook.setter;\n      },\n\n      state: defaultValue => {\n        const hook = this.useHook(\"state\");\n        if (!hook.setter) {\n          hook.value = defaultValue;\n          hook.setter = nextValue => {\n            if (nextValue === hook.value) return;\n            hook.value = nextValue;\n            this.forceUpdate();\n          };\n        }\n\n        return [hook.value, hook.setter];\n      },\n\n      use: (hook, ...args) => hook(this.hookContext, ...args),\n\n      effect: (factory, inputs) => {\n        const hook = this.useHook(\"effect\");\n        return this.memoize(\n          hook,\n          (...args) =>\n            this.onMount(() => {\n              hook.dispose && hook.dispose();\n              hook.dispose = factory(...args);\n            }),\n          inputs\n        );\n      },\n\n      memo: (factory, inputs) => {\n        const hook = this.useHook(\"memo\");\n        return this.memoize(hook, factory, inputs);\n      },\n\n      context: (...args) => {\n        let contextName = \"default\";\n        if (typeof args[0] === \"string\") {\n          contextName = args.shift();\n        }\n        const context =\n          contexts[contextName] || (contexts[contextName] = createContext());\n\n        // is consumer\n        if (typeof args[0] === \"function\") {\n          return createElement(context.Consumer, {}, args[0]);\n        }\n        return createElement(context.Provider, {\n          value: args[0],\n          children: args[1]\n        });\n      }\n    };\n\n    onMount = handler => {\n      if (this.mount) {\n        handler();\n      } else {\n        this.didMountHandlers.push(handler);\n      }\n    };\n\n    componentDidMount() {\n      this.mount = true;\n      this.didMountHandlers.forEach(handler => handler());\n      this.didMountHandlers.length = 0;\n    }\n\n    componentWillUnmount() {\n      this.mount = false;\n      this.hookContext.hooks.forEach(hook => {\n        hook.type === \"effect\" && hook.dispose && hook.dispose();\n      });\n    }\n\n    render() {\n      const { props, hookContext } = this;\n      // reset hook index\n      hookContext.index = 0;\n      return render(props, hookContext);\n    }\n  }\n\n  StatefulComponent.displayName = render.displayName || render.name;\n\n  return StatefulComponent;\n}\n"],"file":"index.js"}