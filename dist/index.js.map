{"version":3,"sources":["../index.js"],"names":["contexts","stateful","render","StatefulComponent","type","hookContext","index","hooks","hook","length","Error","factory","inputs","some","input","value","ref","useHook","setter","current","state","defaultValue","nextValue","forceUpdate","use","args","effect","memoize","onMount","dispose","memo","context","contextName","shift","Consumer","Provider","children","handler","mount","didMountHandlers","push","forEach","props","PureComponent","displayName","name"],"mappings":"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","sourcesContent":["import { PureComponent, createContext, createElement } from \"react\";\n\nconst contexts = {};\n\nexport function stateful(render) {\n  class StatefulComponent extends PureComponent {\n    didMountHandlers = [];\n\n    useHook = type => {\n      const { hookContext } = this;\n      const { index, hooks } = hookContext;\n      // create new hook if not any\n      const hook =\n        hooks[index] ||\n        (hooks[index] = {\n          type,\n          index: hooks.length\n        });\n      if (type !== hook.type) {\n        throw new Error(\"Invalid hook usage\");\n      }\n      hookContext.index++;\n      return hook;\n    };\n\n    memoize = (hook, factory, inputs = []) => {\n      if (\n        !hook.inputs ||\n        hook.inputs.some((input, index) => input !== inputs[index])\n      ) {\n        hook.value = factory(...inputs);\n        hook.inputs = inputs;\n      }\n      return hook.value;\n    };\n\n    hookContext = {\n      hooks: [],\n      index: 0,\n      ref: () => {\n        const hook = this.useHook(\"ref\");\n        if (!hook.setter) {\n          hook.setter = value => (hook.setter.current = value);\n        }\n        return hook.setter;\n      },\n      state: defaultValue => {\n        const hook = this.useHook(\"state\");\n        if (!hook.setter) {\n          hook.value = defaultValue;\n          hook.setter = nextValue => {\n            if (nextValue === hook.value) return;\n            hook.value = nextValue;\n            this.forceUpdate();\n          };\n        }\n\n        return [hook.value, hook.setter];\n      },\n      use: (hook, ...args) => hook(this.hookContext, ...args),\n      effect: (factory, inputs) => {\n        const hook = this.useHook(\"effect\");\n        return this.memoize(\n          hook,\n          (...args) =>\n            this.onMount(() => {\n              hook.dispose && hook.dispose();\n              hook.dispose = factory(...args);\n            }),\n          inputs\n        );\n      },\n      memo: (factory, inputs) => {\n        const hook = this.useHook(\"memo\");\n        return this.memoize(hook, factory, inputs);\n      },\n      context: (...args) => {\n        let contextName = \"default\";\n        if (typeof args[0] === \"string\") {\n          contextName = args.shift();\n        }\n        const context =\n          contexts[contextName] || (contexts[contextName] = createContext());\n\n        // is consumer\n        if (typeof args[0] === \"function\") {\n          return createElement(context.Consumer, {}, args[0]);\n        }\n        return createElement(context.Provider, {\n          value: args[0],\n          children: args[1]\n        });\n      }\n    };\n\n    onMount = handler => {\n      if (this.mount) {\n        handler();\n      } else {\n        this.didMountHandlers.push(handler);\n      }\n    };\n\n    componentDidMount() {\n      this.mount = true;\n      this.didMountHandlers.forEach(handler => handler());\n      this.didMountHandlers.length = 0;\n    }\n\n    componentWillUnmount() {\n      this.mount = false;\n      this.hookContext.hooks.forEach(hook => {\n        hook.type === \"effect\" && hook.dispose && hook.dispose();\n      });\n    }\n\n    render() {\n      const { props, hookContext } = this;\n      // reset hook index\n      hookContext.index = 0;\n      return render(props, hookContext);\n    }\n  }\n\n  StatefulComponent.displayName = render.displayName || render.name;\n\n  return StatefulComponent;\n}\n"],"file":"index.js"}